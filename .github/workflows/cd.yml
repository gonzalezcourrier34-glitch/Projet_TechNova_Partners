name: CD  # Nom du workflow (ce que tu vois dans l’onglet Actions)

on:
  push:
    branches: ["main"]  # Le workflow se lance quand on push sur la branche main

jobs:
  test:
    name: tests_CD  # Job 1 : on lance les tests (si ça casse, on déploie pas)
    runs-on: ubuntu-latest  # La machine GitHub (Linux) utilisée pour exécuter le job

    steps:
      - name: Checkout
        uses: actions/checkout@v4  # Récupère le code du repo dans la machine CI

      - name: Set up Python
        uses: actions/setup-python@v5  # Installe Python sur la machine
        with:
          python-version: "3.13"  # Version de Python utilisée pour tests + install

      - name: Install Poetry
        uses: snok/install-poetry@v1  # Installe Poetry (gestion des dépendances)
        with:
          version: "2.0.0"  # Version fixe pour éviter les surprises
          virtualenvs-create: true  # Crée un environnement virtuel
          virtualenvs-in-project: true  # Met le venv dans le projet (.venv)

      - name: Install dependencies (with dev)
        run: poetry install --no-interaction --with dev  # Installe aussi les deps de dev (pytest, etc.)

      - name: Run tests (SQLite file)
        env:
          API_KEY: "ci-test-key"  # Clé fake pour les tests (pas une vraie)
          DATABASE_URL: "sqlite+pysqlite:////tmp/test.db"  # DB SQLite temporaire sur la machine CI
        run: poetry run pytest -q  # Lance pytest en mode silencieux

  build-and-push:
    name: build_and_push_GHCR  # Job 2 : build l'image Docker + push sur GHCR
    runs-on: ubuntu-latest
    needs: test  # Ce job ne démarre QUE si les tests sont OK

    permissions:
      contents: read  # Autorise la lecture du repo
      packages: write  # Autorise à pousser l’image dans GHCR (registry GitHub)

    steps:
      - name: Checkout
        uses: actions/checkout@v4  # Récupère le code (nécessaire pour docker build)

      - name: Compute image name (lowercase)
        id: vars
        run: echo "image_name=ghcr.io/${GITHUB_REPOSITORY,,}" >> "$GITHUB_OUTPUT"
        # Transforme "Owner/Repo" en "owner/repo" car GHCR refuse les majuscules

      - name: Log in to GHCR
        uses: docker/login-action@v3  # Login au registry GHCR
        with:
          registry: ghcr.io
          username: ${{ github.actor }}  # Utilise l’utilisateur GitHub qui déclenche l’action
          password: ${{ secrets.GITHUB_TOKEN }}  # Token GitHub auto fourni pour accéder à GHCR

      - name: Build and push image
        uses: docker/build-push-action@v6  # Build l'image + push si "push: true"
        with:
          context: .  # Le Dockerfile est dans le repo (racine)
          push: true  # Envoie l’image construite dans GHCR
          tags: |
            ${{ steps.vars.outputs.image_name }}:latest  # Tag pratique (dernier build)
            ${{ steps.vars.outputs.image_name }}:${{ github.sha }}  # Tag unique (commit exact)

  deploy-huggingface:
    name: deploy_to_huggingface  # Job 3 : déploiement sur Hugging Face Spaces
    runs-on: ubuntu-latest
    needs: build-and-push  # Déploiement seulement si l'image a été push correctement

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Récupère tout l’historique git (utile si HF a besoin de commits)

      - name: Push to Hugging Face Space (force)
        env:
          HF_TOKEN: "${{ secrets.HF_TOKEN }}"  # Token HF stocké dans les secrets GitHub
        run: |
          set -euo pipefail
          # -e : stop si erreur, -u : stop si variable manquante, -o pipefail : erreur dans les pipes

          git config --global user.email "ci@github.com"
          git config --global user.name "github-actions"
          # Configure git pour que les commits/push aient un auteur "CI"

          # évite l'erreur si le remote existe déjà
          git remote remove hf 2>/dev/null || true
          git remote add hf https://huggingface.co/spaces/SteGONZALEZ/technova-api
          # Ajoute le remote HF (un peu comme "origin" mais pour Hugging Face)

          # push authentifié vers HF (avec token) + force comme tu fais d'habitude
          git push --force https://SteGONZALEZ:${HF_TOKEN}@huggingface.co/spaces/SteGONZALEZ/technova-api main
          # Force push : remplace l’état du Space par ce qu’il y a sur main
